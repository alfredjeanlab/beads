# OCI image build for kbeads — crane-based push to GHCR.
#
# Builds kd binary, installs runtime deps, assembles a layer, and pushes
# via crane append to ubuntu:24.04 base.
#
# OPTIMIZATIONS:
# - Filter directives on Go build (cached by lockfiles)
# - Content-based caching on system deps and Go modules

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, '20') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
      status-checks:
        name: Image
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
      status-checks:
        - tasks: [build-kd]
          name: Image
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ── System deps (cached until lock changes) ────────────────────────
  - key: system-deps
    filter:
      - .rwx/system-deps.lock
    run: |
      echo "Installing build dependencies (should be cached)..."
      sudo apt-get update
      sudo apt-get install -y libicu-dev gcc g++

  # ── Clone kbeads repo ─────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/kbeads.git
      ref: ${{ init.commit-sha }}

  # ── Go toolchain (cached by version, see .go-version) ─────────────
  - key: go
    call: golang/install 1.2.0
    with:
      go-version: "1.25"
    filter:
      - .go-version

  # ── Go mod download (cached by lockfiles) ──────────────────────────
  - key: go-deps
    use: [code, go, system-deps]
    run: go mod download
    filter:
      - go.mod
      - go.sum

  # ── Build kd binary (only when Go code changes) ───────────────────
  - key: build-kd
    use: [go-deps]
    filter:
      - "*.go"
      - "cmd/kd/*.go"
      - "cmd/**/*.go"
      - "internal/**/*.go"
      - "internal/**/*.sql"
      - "gen/**/*.go"
      - "go.mod"
      - "go.sum"
    run: |
      echo "Building kd binary..."
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"
      CGO_ENABLED=1 GOOS=linux go build \
        -ldflags="-s -w -X main.Version=${TAG} -X main.Build=${COMMIT_SHA}" \
        -o kd ./cmd/kd
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    outputs:
      artifacts:
        - key: kd-binary
          path: kd

  # ── Push kd daemon image to GHCR ──────────────────────────────────
  - key: push-kd
    use: [build-kd]
    if: ${{ init.ref-name != 'pr' }}
    cache: false
    run: |
      set -e
      TAG="${REF_NAME#refs/tags/}"
      TAG="${TAG#refs/heads/}"

      # Install crane
      curl -fsSL "https://github.com/google/go-containerregistry/releases/download/v0.20.2/go-containerregistry_Linux_x86_64.tar.gz" \
        | tar xz -C /tmp crane
      sudo mv /tmp/crane /usr/local/bin/

      # Login to GHCR
      echo "$GHCR_TOKEN" | crane auth login ghcr.io -u "$GITHUB_USER" --password-stdin

      # Install runtime deps on build VM
      export DEBIAN_FRONTEND=noninteractive
      sudo apt-get -y update
      sudo apt-get -y install --no-install-recommends \
        ca-certificates tzdata libicu74 netcat-openbsd

      # Build layer tree
      LAYER=/tmp/layer
      mkdir -p $LAYER/usr/local/bin $LAYER/etc/ssl/certs $LAYER/home/beads

      # Copy runtime deps via dpkg -L
      for pkg in ca-certificates tzdata libicu74 netcat-openbsd; do
        dpkg -L "$pkg" 2>/dev/null | while read -r f; do
          [ -f "$f" ] || continue
          mkdir -p "$LAYER$(dirname "$f")"
          cp "$f" "$LAYER${f}" 2>/dev/null || true
        done || true
      done

      # Copy shared libs for kd binary
      ldd ${{ tasks.build-kd.artifacts.kd-binary }} 2>/dev/null | grep "=> /" | awk '{print $3}' | while read -r lib; do
        [ -f "$lib" ] || continue
        mkdir -p "$LAYER$(dirname "$lib")"
        cp -n "$lib" "$LAYER${lib}" 2>/dev/null || true
      done || true

      # ICU data files (needed at runtime)
      find /usr/lib/x86_64-linux-gnu -name 'libicu*.so*' 2>/dev/null | while read -r f; do
        mkdir -p "$LAYER$(dirname "$f")"
        cp -a "$f" "$LAYER${f}" 2>/dev/null || true
      done || true

      # Install kd binary
      cp ${{ tasks.build-kd.artifacts.kd-binary }} $LAYER/usr/local/bin/kd
      chmod 755 $LAYER/usr/local/bin/kd

      # CA certs
      cp /etc/ssl/certs/ca-certificates.crt $LAYER/etc/ssl/certs/

      # Agent user (rename ubuntu→beads in passwd/group, UID 1000)
      cp /etc/passwd $LAYER/etc/passwd
      sed -i "s/^ubuntu:/beads:/" $LAYER/etc/passwd
      sed -i "s|/home/ubuntu|/home/beads|" $LAYER/etc/passwd
      cp /etc/group $LAYER/etc/group
      sed -i "s/^ubuntu:/beads:/" $LAYER/etc/group

      # Fix ownership
      sudo chown -R 1000:1000 $LAYER/home/beads
      sudo chown 1000:1000 $LAYER/usr/local/bin/kd

      # Create tar and push
      sudo tar -cf /tmp/layer.tar -C $LAYER .

      REPO="ghcr.io/groblegark/kbeads"
      crane append --base ubuntu:24.04 --new_tag "${REPO}:${TAG}" --new_layer /tmp/layer.tar --platform linux/amd64
      crane mutate "${REPO}:${TAG}" \
        --entrypoint /usr/local/bin/kd \
        --cmd "daemon,start,--foreground,--tcp-addr=:9876,--http-addr=:9877,--log-json" \
        --user beads \
        --workdir /home/beads \
        -t "${REPO}:${TAG}"
      crane tag "${REPO}:${TAG}" latest
      echo "Pushed ${REPO}:${TAG} and ${REPO}:latest"
    env:
      REF_NAME: ${{ init.ref-name }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}
